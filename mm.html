<!doctype html>
<html>
    <head>
        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<style>
	  .arjs-loader {
		height: 100%;
		width: 100%;
		position: absolute;
		top: 0;
		left: 0;
		background-color: rgba(0, 0, 0, 0.8);
		z-index: 9999;
		display: flex;
		justify-content: center;
		align-items: center;
	  }
	  .arjs-loader div {
		text-align: center;
		font-size: 1.25em;
		color: white;
	  }
	</style>
	
          
    </head>

        <body style="margin : 0px; overflow: hidden;">
            <!-- minimal loader shown until image descriptors are loaded -->
            <div class="arjs-loader">
              <div>Loading, please wait...</div>
            </div>
        <a-scene
            vr-mode-ui="enabled: false;"
            loading-screen="enabled: false;"
            arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
            id="scene"
            embedded arjs="sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false;"
            gesture-detector
        >
            <a-marker
                id="animated-marker"
                type="pattern"
                preset="custom"
                url="assets/marker.patt"
                raycaster="objects: .clickable"
                emitevents="true"
                cursor="fuse: false; rayOrigin: mouse;"
                id="markerA"
            >
                <a-image
                    src="assets/asset.png"
                    scale="1 1 1"
                    class="clickable"
                    rotation="-90 0 0"
                    gesture-handler
                ></a-image>
            </a-marker>

            <a-entity camera></a-entity>
        </a-scene>
        <div class="container">
            <div class="app">
              <a href="#" id="start-camera" class="visible">Touch here to start the app.</a>
              <img id="snap">
              <p id="error-message"></p>
              <a href="#" id="delete-photo" title="Delete Photo" class="disabled"><i class="material-icons">delete</i></a>
              <a href="#" id="take-photo" title="Take Photo"><i class="material-icons">camera_alt</i></a>
              <a href="#" id="download-photo" download="selfie.png" title="Save Photo" class="disabled"><i class="material-icons">file_download</i></a>   
            </div>
        </div>
        <script>
              var sceneEl = document.querySelector('a-scene');
              var counter = 0;
      
              let shareData;
              document.addEventListener('pointerup', (event) => {
                  if (counter%2 !== 0) {
                      navigator.share(shareData).then(function()    {}).catch(function(err) {alert(err);});
                      ++counter;
                      return;
                  }
                  function captureVideos() {
                    var canvas = document.getElementById("canvas"); // declare a canvas element in your html
                    var ctx = canvas.getContext("2d");
                    var videos = document.querySelectorAll("video");
                    var i, w, h;
      
                    for (i = 0, len = videos.length; i < len; i++) {
                      const v = videos[i];
                      
                      try {
                          w = v.videoWidth;
                          h = v.videoHeight;
                          canvas.width = w;
                          canvas.height = h;
                          ctx.fillRect(0, 0, w, h);
                          ctx.drawImage(v, 0, 0, w, h);
                          const a = canvas.toDataURL();
                          v.style.backgroundImage = "url(" + a + ")";
                          ctx.clearRect(0, 0, w, h); // clean the canvas
                          canvas.width = canvas.height = 0;
                      } catch(e) {
                          console.log(e);
                      }
                    }
                  }
                  
                  captureVideos();
                  sceneEl.renderer.render(sceneEl.object3D, sceneEl.camera);
                  html2canvas(document.body, {width: document.documentElement.offsetWidth, height: document.documentElement.offsetHeight}).then(function(canvas) {
                      function dataURLtoFile(dataurl) {
                          var bstr = atob(dataurl.split(',')[1]), n = bstr.length, u8arr = new Uint8Array(n);
                          while(n--){
                              u8arr[n] = bstr.charCodeAt(n);
                          }
                          return u8arr;
                      }
                              
                      const dataURL = canvas.toDataURL();
                      const byteArray = dataURLtoFile(dataURL);
                      shareData = {
                          files: [new File([byteArray], "bla.png", {type: "image/png"})]
                      };
                      alert("done");
                  }).catch(e => {
                      alert(e);
                      console.error(e);
                      
                  });
                  ++counter;
              });
          </script>
      </body>
</html>
